<?php

/**
 * @Project NUKEVIET 3.4
 * @Author VINADES.,JSC (contact@vinades.vn)
 * @Copyright (C) 2010 - 2012 VINADES.,JSC. All rights reserved
 * @Createdate Sun, 08 Apr 2012 00:00:00 GMT GMT
 */

require_once(NV_ROOTDIR."/includes/class/nusoap.php");class NL_Checkout{private $nganluong_url='';private $merchant_site_code;private $secure_pass;function __construct($nganluong_url,$merchant_site_code,$secure_pass){$this->nganluong_url=trim($nganluong_url);$this->merchant_site_code=trim($merchant_site_code);$this->secure_pass=trim($secure_pass);}public function buildCheckoutUrl($return_url,$receiver,$transaction_info,$order_code,$price){$arr_param=array('merchant_site_code'=>strval($this->merchant_site_code),'return_url'=>strtolower(urlencode($return_url)),'receiver'=>strval($receiver),'transaction_info'=>strval($transaction_info),'order_code'=>strval($order_code),'price'=>strval($price));$secure_code=implode(' ',$arr_param).' '.$this->secure_pass;$arr_param['secure_code']=md5($secure_code);$redirect_url=$this->nganluong_url;if(strpos($redirect_url,'?')===false){$redirect_url.='?';}else if(substr($redirect_url,strlen($redirect_url)-1,1)!='?'&&strpos($redirect_url,'&')===false){$redirect_url.='&';}$url='';foreach($arr_param as $key=>$value){if($url=='')$url.=$key.'='.$value;else $url.='&'.$key.'='.$value;}return $redirect_url.$url;}public function verifyPaymentUrl($transaction_info,$order_code,$price,$payment_id,$payment_type,$error_text,$secure_code){$str='';$str.=' '.strval($transaction_info);$str.=' '.strval($order_code);$str.=' '.strval($price);$str.=' '.strval($payment_id);$str.=' '.strval($payment_type);$str.=' '.strval($error_text);$str.=' '.strval($this->merchant_site_code);$str.=' '.strval($this->secure_pass);$verify_secure_code=md5($str);if($verify_secure_code===$secure_code)return true;return false;}public function checkOrder($public_api_url,$order_code,$payment_id){$payment_id=(empty($payment_id))?"":$payment_id;$param="<ORDERS>\n                \t<TOTAL>1</TOTAL>\n                \t<ORDER>\n                \t\t<ORDER_CODE>".$order_code."</ORDER_CODE>\n                \t\t<PAYMENT_ID>".$payment_id."</PAYMENT_ID>\t\t\n                \t</ORDER>\n                </ORDERS>";$client=new nusoap_client($public_api_url,'wsdl');$result=$client->call('checkOrder',array('merchant_id'=>$this->merchant_site_code,'param'=>$param,'checksum'=>md5($this->merchant_site_code.$param.$this->secure_pass)));if($xml=simplexml_load_string($result)){$error_code=( string )$xml->ERROR_CODE;if($error_code=="00"){$transaction=$xml->xpath('TRANSACTION');$data=array_map("trim",( array )$transaction[0]);if($data['TRANSACTION_ERROR_CODE']=='00'){$preg_match_time='/(\d{2}):(\d{2}):(\d{2}) - (\d{2})\/(\d{2})\/(\d{4})/';unset($matches);preg_match($preg_match_time,$data['CREATED_TIME'],$matches);$data['CREATED_TIME']=mktime($matches[1],$matches[2],$matches[3],$matches[5],$matches[4],$matches[6]);unset($matches);preg_match($preg_match_time,$data['PAID_TIME'],$matches);$data['PAID_TIME']=mktime($matches[1],$matches[2],$matches[3],$matches[5],$matches[4],$matches[6]);$data['nv_transaction_status']=intval($data['TRANSACTION_STATUS']);return $data;}}}return false;}public function checkOrders($public_api_url,$array_order){$data_orders_return=array();$param="<ORDERS>\n\t\t\t<TOTAL>".sizeof($array_order)."</TOTAL>";foreach($array_order as $arr_order_i){$payment_id=(empty($arr_order_i['payment_id']))?"":$arr_order_i['payment_id'];$param.="<ORDER>\n                \t\t<ORDER_CODE>".$arr_order_i['order_code']."</ORDER_CODE>\n                \t\t<PAYMENT_ID>".$payment_id."</PAYMENT_ID>\t\t\n                \t</ORDER>";}$param.="</ORDERS>";$client=new nusoap_client($public_api_url,'wsdl');$result=$client->call('checkOrder',array('merchant_id'=>$this->merchant_site_code,'param'=>$param,'checksum'=>md5($this->merchant_site_code.$param.$this->secure_pass)));if($xml=simplexml_load_string($result)){$error_code=( string )$xml->ERROR_CODE;if($error_code=="00"){$transactions=$xml->xpath('TRANSACTION');foreach($transactions as $transaction){$data=array_map("trim",( array )$transaction);if($data['TRANSACTION_ERROR_CODE']=='00'){$preg_match_time='/(\d{2}):(\d{2}):(\d{2}) - (\d{2})\/(\d{2})\/(\d{4})/';unset($matches);preg_match($preg_match_time,$data['CREATED_TIME'],$matches);$data['CREATED_TIME']=mktime($matches[1],$matches[2],$matches[3],$matches[5],$matches[4],$matches[6]);unset($matches);preg_match($preg_match_time,$data['PAID_TIME'],$matches);$data['PAID_TIME']=mktime($matches[1],$matches[2],$matches[3],$matches[5],$matches[4],$matches[6]);$data['nv_transaction_status']=intval($data['TRANSACTION_STATUS']);$data_orders_return[]=$data;}}}}return $data_orders_return;}}

?>